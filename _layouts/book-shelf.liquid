---
layout: page
---
{{ content }}

{% if page.collection and page.collection.size > 0 %}
  {% assign collection = site[page.collection] %}
  {% assign group_by = page.group_by | default: 'year' %}
  {% assign category_field = page.category_field | default: 'categories' %}
  {% assign allowed_categories = page.allowed_categories %}
  {% assign fallback_category = page.fallback_category | default: 'Uncategorized' %}

  {% if collection and collection.size > 0 %}
    {% if group_by == 'category' %}
      {% assign books = collection %}
      {% assign all_categories = '' | split: '' %}

      {% for item in books %}
        {% assign cat_list = item[category_field] %}
        {% if cat_list == null or cat_list == empty %}
          {% assign cat_list = item.tags %}
        {% endif %}

        {% assign cat_raw = '' %}
        {% if cat_list %}
          {% assign cat_raw = cat_list | join: ',' %}
          {% if cat_raw == '' %}
            {% assign cat_raw = cat_list %}
          {% endif %}
        {% endif %}
        {% if cat_raw == '' %}
          {% assign cat_raw = fallback_category %}
        {% endif %}

        {% assign cat_list = cat_raw | replace: ';', ',' | replace: ' ,', ',' | replace: '  ', ' ' | replace: ' ', ',' | split: ',' %}
        {% if cat_list == null or cat_list == empty %}
          {% assign cat_list = fallback_category | split: ',' %}
        {% endif %}

        {% assign mapped_cats = '' | split: '' %}
        {% assign has_real_cat = false %}
        {% for cat in cat_list %}
          {% assign cat_name = cat | strip %}
          {% assign cat_key = cat_name | downcase %}
          {% if page.category_map and page.category_map[cat_key] %}
            {% assign cat_name = page.category_map[cat_key] %}
          {% endif %}
          {% if cat_name == '' %}
            {% assign cat_name = fallback_category %}
          {% endif %}
          {% if allowed_categories and allowed_categories != empty %}
            {% unless allowed_categories contains cat_name %}
              {% assign cat_name = fallback_category %}
            {% endunless %}
          {% endif %}
          {% if cat_name != fallback_category %}
            {% assign has_real_cat = true %}
          {% endif %}
          {% assign mapped_cats = mapped_cats | push: cat_name %}
        {% endfor %}

        {% assign final_cats = '' | split: '' %}
        {% for mapped in mapped_cats %}
          {% if has_real_cat and mapped == fallback_category %}
            {% continue %}
          {% endif %}
          {% unless final_cats contains mapped %}
            {% assign final_cats = final_cats | push: mapped %}
          {% endunless %}
        {% endfor %}

        {% for cat_name in final_cats %}
          {% unless all_categories contains cat_name %}
            {% assign all_categories = all_categories | push: cat_name %}
          {% endunless %}
        {% endfor %}
      {% endfor %}

      {% assign all_categories = all_categories | uniq | sort_natural %}

      {% if page.category_order %}
        {% assign ordered_categories = '' | split: '' %}
        {% for desired in page.category_order %}
          {% if all_categories contains desired %}
            {% assign ordered_categories = ordered_categories | push: desired %}
          {% endif %}
        {% endfor %}
        {% for cat in all_categories %}
          {% unless ordered_categories contains cat %}
            {% assign ordered_categories = ordered_categories | push: cat %}
          {% endunless %}
        {% endfor %}
        {% assign all_categories = ordered_categories %}
      {% endif %}

      {% if all_categories.size > 0 %}
        <div class="book-category-nav">
          {% for cat in all_categories %}
            <a href="#{{ cat | slugify }}">{{ cat }}</a>
            {%- unless forloop.last %} &middot; {% endunless %}
          {% endfor %}
        </div>
      {% endif %}

      {% for cat in all_categories %}
        <h1 id="{{ cat | slugify }}">{{ cat }}</h1>
        <div class="book-grid">
          {% for item in books %}
            {% assign cat_list = item[category_field] %}
            {% if cat_list == null or cat_list == empty %}
              {% assign cat_list = item.tags %}
            {% endif %}

            {% assign cat_raw = '' %}
            {% if cat_list %}
              {% assign cat_raw = cat_list | join: ',' %}
              {% if cat_raw == '' %}
                {% assign cat_raw = cat_list %}
              {% endif %}
            {% endif %}
            {% if cat_raw == '' %}
              {% assign cat_raw = fallback_category %}
            {% endif %}

            {% assign cat_list = cat_raw | replace: ';', ',' | replace: ' ,', ',' | replace: '  ', ' ' | replace: ' ', ',' | split: ',' %}
            {% if cat_list == null or cat_list == empty %}
              {% assign cat_list = fallback_category | split: ',' %}
            {% endif %}

            {% assign has_cat = false %}
            {% assign mapped_cats = '' | split: '' %}
            {% assign has_real_cat = false %}
            {% for cat_value in cat_list %}
              {% assign cat_name = cat_value | strip %}
              {% assign cat_key = cat_name | downcase %}
              {% if page.category_map and page.category_map[cat_key] %}
                {% assign cat_name = page.category_map[cat_key] %}
              {% endif %}
              {% if cat_name == '' %}
                {% assign cat_name = fallback_category %}
              {% endif %}
              {% if allowed_categories and allowed_categories != empty %}
                {% unless allowed_categories contains cat_name %}
                  {% assign cat_name = fallback_category %}
                {% endunless %}
              {% endif %}
              {% if cat_name != fallback_category %}
                {% assign has_real_cat = true %}
              {% endif %}
              {% assign mapped_cats = mapped_cats | push: cat_name %}
            {% endfor %}

            {% assign final_cats = '' | split: '' %}
            {% for mapped in mapped_cats %}
              {% if has_real_cat and mapped == fallback_category %}
                {% continue %}
              {% endif %}
              {% unless final_cats contains mapped %}
                {% assign final_cats = final_cats | push: mapped %}
              {% endunless %}
            {% endfor %}

            {% for cat_name in final_cats %}
              {% if cat_name == cat %}
                {% assign has_cat = true %}
              {% endif %}
            {% endfor %}

            {% if has_cat %}
              <figure class="cover">
                <a class="cover-link" href="{{ item.url | relative_url }}">
                  {% if item.cover %}
                    <img alt="{{ item.title }} cover" src="{{ item.cover | prepend: page.covers | relative_url }}" style="height:200px">
                  {% elsif item.olid %}
                    <img
                      alt="{{ item.title }} cover"
                      src="http://covers.openlibrary.org/b/olid/{{ item.olid }}-L.jpg?default=false"
                      style="height:200px"
                    >
                  {% elsif item.isbn %}
                    <img
                      alt="{{ item.title }} cover"
                      src="http://covers.openlibrary.org/b/isbn/{{ item.isbn }}-L.jpg?default=false"
                      style="height:200px"
                    >
                  {% endif %}
                  {% if item.status %}
                    {% assign statuses = 'abandoned,finished,interested,paused,queued,reading,reread' | split: ',' %}
                    {% assign status = item.status | downcase | strip %}
                    {% if statuses contains status %}
                      <figcaption class="{{ status | downcase }}">{{ status | upcase }}</figcaption>
                    {% else %}
                      <figcaption class="uncategorized">UNCATEGORIZED</figcaption>
                    {% endif %}
                  {% else %}
                    <figcaption class="uncategorized">UNCATEGORIZED</figcaption>
                  {% endif %}
                </a>
              </figure>
            {% endif %}
          {% endfor %}
        </div>
      {% endfor %}
    {% else %}
      {% for item in collection reversed %}
        {% assign current_year = item.date | date: '%Y' %}
        {% if current_year != year %}
          {% unless forloop.first %}
            </ul>
          {% endunless %}
          <h1 id="y{{item.date | date: "%Y"}}">
            <a href="{{ current_year | prepend: '/books/' | relative_url }}">{{ current_year }}</a>
          </h1>
          <ul>
            {% assign year = current_year %}
        {% endif %}

        <figure class="cover">
          <a class="cover-link" href="{{ item.url | relative_url }}">
            {% if item.cover %}
              <img alt="{{ item.title }} cover" src="{{ item.cover | prepend: page.covers | relative_url }}" style="height:200px">
            {% elsif item.olid %}
              <img alt="{{ item.title }} cover" src="http://covers.openlibrary.org/b/olid/{{ item.olid }}-L.jpg?default=false" style="height:200px">
            {% elsif item.isbn %}
              <img alt="{{ item.title }} cover" src="http://covers.openlibrary.org/b/isbn/{{ item.isbn }}-L.jpg?default=false" style="height:200px">
            {% endif %}
            {% if item.status %}
              {% assign statuses = 'abandoned,finished,interested,paused,queued,reading,reread' | split: ',' %}
              {% assign status = item.status | downcase | strip %}
              {% if statuses contains status %}
                <figcaption class="{{ status | downcase }}">{{ status | upcase }}</figcaption>
              {% else %}
                <figcaption class="uncategorized">UNCATEGORIZED</figcaption>
              {% endif %}
            {% else %}
              <figcaption class="uncategorized">UNCATEGORIZED</figcaption>
            {% endif %}
          </a>
        </figure>
        {% if forloop.last %}
          </ul>
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}
{% endif %}

<style>
  .book-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    padding: 0;
    margin: 0 0 2rem;
  }

  .book-grid .cover {
    margin: 0;
  }

  .book-category-nav {
    margin: 0 0 1rem;
  }

  .book-category-nav a {
    white-space: nowrap;
  }
</style>
